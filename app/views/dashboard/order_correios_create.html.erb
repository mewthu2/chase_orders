<div class="container-fluid py-4">
  <% title 'Criação de Pedidos no Correios' %>

  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <a href="<%= root_path %>" class="btn btn-dark me-2">
            <i class="fas fa-tachometer-alt me-1"></i> Dashboard
          </a>
          <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
            <i class="fas fa-filter me-1"></i> Filtros
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="collapse mb-4" id="filtersCollapse">
    <div class="card bg-black border border-dark shadow">
      <div class="card-header bg-dark">
        <h5 class="text-white mb-0">
          <i class="fas fa-filter me-2"></i>Filtros
        </h5>
      </div>
      <div class="card-body">
        <form action="<%= order_correios_create_dashboard_index_path %>" method="get">
          <div class="row g-3">
            <div class="col-md-4">
              <label for="status" class="form-label text-white">Status</label>
              <select name="status" id="status" class="form-select bg-dark text-white border-secondary">
                <option value="">Todos</option>
                <option value="pending">Pendente</option>
                <option value="processing">Processando</option>
                <option value="success">Sucesso</option>
                <option value="error">Erro</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="period" class="form-label text-white">Período</label>
              <select name="period" id="period" class="form-select bg-dark text-white border-secondary">
                <option value="">Todo o período</option>
                <option value="today">Hoje</option>
                <option value="7">Últimos 7 dias</option>
                <option value="30">Últimos 30 dias</option>
                <option value="90">Últimos 90 dias</option>
              </select>
            </div>
            <div class="col-md-4">
              <label for="order_id" class="form-label text-white">ID do Pedido</label>
              <input type="text" name="order_id" id="order_id" class="form-control bg-dark text-white border-secondary" placeholder="Ex: 123456">
            </div>
          </div>
          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-search me-1"></i> Aplicar Filtros
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Estatísticas -->
  <div class="row mb-4">
    <div class="col-md-2">
      <div class="card bg-dark border border-secondary shadow-sm">
        <div class="card-body text-center">
          <i class="fas fa-shopping-cart fa-2x text-primary mb-2"></i>
          <h4 class="text-white"><%= @stats[:total_orders] %></h4>
          <small class="text-muted">Total Pedidos</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-dark border border-secondary shadow-sm">
        <div class="card-body text-center">
          <i class="fas fa-clock fa-2x text-warning mb-2"></i>
          <h4 class="text-white"><%= @stats[:pending_orders] %></h4>
          <small class="text-muted">&nbsp;</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-dark border border-secondary shadow-sm">
        <div class="card-body text-center">
          <i class="fas fa-list fa-2x text-info mb-2"></i>
          <h4 class="text-white"><%= @stats[:in_queue] %></h4>
          <small class="text-muted">Na Fila</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-dark border border-secondary shadow-sm">
        <div class="card-body text-center">
          <i class="fas fa-spinner fa-2x text-primary mb-2"></i>
          <h4 class="text-white"><%= @stats[:processing] %></h4>
          <small class="text-muted">Processando</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-dark border border-secondary shadow-sm">
        <div class="card-body text-center">
          <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
          <h4 class="text-white"><%= @stats[:successful] %></h4>
          <small class="text-muted">Processados</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card bg-dark border border-secondary shadow-sm">
        <div class="card-body text-center">
          <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
          <h4 class="text-white"><%= @stats[:failed] %></h4>
          <small class="text-muted">Com Erro</small>
        </div>
      </div>
    </div>
  </div>

  <div class="alert alert-info border-0 mb-4">
    <div class="d-flex align-items-center">
      <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
      <div>
        <h5 class="mb-1">Fluxo de Processamento</h5>
        <p class="mb-0">1. Pedidos "Preparando Envio" → 2. Criação Correios → 3. Emissão de Nota → 4. Envio XML → 5. Rastreamento</p>
      </div>
    </div>
  </div>

  <!-- Tabela de Pedidos Aguardando -->
  <div class="card bg-dark border border-secondary shadow-sm">
    <div class="card-header bg-secondary">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="text-white mb-0">
          <i class="fas fa-plus-circle me-2"></i>Pedidos Aguardando Criação no Correios
        </h5>
        <div>
          <span class="badge bg-warning text-dark me-2">
            <i class="fas fa-clock"></i> Aguardando Processamento
          </span>
          <span class="badge bg-primary">
            Criação de Pedidos Correios
          </span>
        </div>
      </div>
    </div>
    <div class="card-body">
      <% if @pending_orders.present? %>
        <div class="table-responsive">
          <table class="table table-dark table-hover" id="ordersTable">
            <thead>
              <tr>
                <th width="50" class="text-center">
                  <i class="fas fa-cog"></i>
                </th>
                <th class="text-center">
                  <i class="fas fa-hashtag me-1"></i>
                  ID Pedido
                </th>
                <th class="text-center">
                  <i class="fas fa-user me-1"></i>
                  Cliente
                </th>
                <th class="text-center">
                  <i class="fas fa-calendar me-1"></i>
                  Data Pedido
                </th>
                <th class="text-center">
                  <i class="fas fa-dollar-sign me-1"></i>
                  Valor Total
                </th>
                <th class="text-center">
                  <i class="fas fa-info-circle me-1"></i>
                  Status Fila
                </th>
                <th class="text-center">
                  <i class="fas fa-list-ol me-1"></i>
                  Posição
                </th>
                <th class="text-center">
                  <i class="fas fa-clock me-1"></i>
                  Última Atualização
                </th>
              </tr>
            </thead>
            <tbody>
              <% @pending_orders.each do |order_data| %>
                <% order = order_data['pedido'] %>
                <% order_id = order['id'].to_s %>
                <% queue_info = @queue_positions[order_id] %>
                
                <tr>
                  <td class="text-center">
                    <div class="d-flex flex-column align-items-center gap-1">
                      <%= link_to verify_attempts_attempts_path(tiny_order_id: order['id']), 
                          class: 'btn btn-sm btn-outline-info', 
                          method: :post, 
                          target: '_blank',
                          title: 'Verificar tentativas' do %>
                        <i class="fas fa-paperclip"></i>
                      <% end %>
                      <button class="btn btn-sm btn-outline-info" 
                              onclick="window.open('<%= ENV.fetch('TINY_SELLS_URL') %>#edit/<%= order['id'] %>', '_blank');"
                              title="Ver no Tiny">
                        <i class="fas fa-external-link-alt"></i>
                      </button>
                    </div>
                  </td>
                  <td class="text-center">
                    <div class="d-flex flex-column align-items-center">
                      <span class="fw-bold text-white">#<%= order['numero'] %></span>
                      <small class="text-muted">ID: <%= order['id'] %></small>
                    </div>
                  </td>
                  <td class="text-center">
                    <div class="d-flex flex-column align-items-center">
                      <span class="text-white"><%= truncate(order['nome'], length: 25) %></span>
                    </div>
                  </td>
                  <td class="text-center">
                    <div class="d-flex flex-column align-items-center">
                      <span class="text-white"><%= order['data_pedido'] %></span>
                    </div>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-success fs-6">R$ <%= number_with_precision(order['valor'].to_f, precision: 2, delimiter: '.', separator: ',') %></span>
                  </td>
                  <td class="text-center">
                    <% if queue_info %>
                      <% if queue_info[:status] == 0 %>
                        <span class="badge bg-warning text-dark">
                          <i class="fas fa-clock"></i>
                          Pendente
                        </span>
                      <% elsif queue_info[:status] == 1 %>
                        <span class="badge bg-primary">
                          <i class="fas fa-spinner fa-spin"></i>
                          Processando
                        </span>
                      <% end %>
                    <% else %>
                      <span class="badge bg-secondary">
                        <i class="fas fa-minus-circle"></i>
                        Aguardando
                      </span>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <% if queue_info %>
                      <div class="d-flex flex-column align-items-center">
                        <span class="badge bg-info text-dark fs-6">#<%= queue_info[:position] %></span>
                        <small class="text-muted">na fila</small>
                      </div>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <% if queue_info %>
                      <div class="d-flex flex-column align-items-center">
                        <span class="text-white"><%= queue_info[:updated_at].strftime('%d/%m/%Y') %></span>
                        <small class="text-muted"><%= queue_info[:updated_at].strftime('%H:%M') %></small>
                      </div>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-5">
          <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
          <h5 class="text-white">Todos os pedidos foram processados</h5>
          <p class="text-muted">Não há pedidos aguardando criação no Correios no momento.</p>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Tabela de Erros Recentes -->
  <% if @failed_attempts.any? %>
    <div class="card bg-dark border border-secondary shadow-sm mt-4">
      <div class="card-header bg-secondary">
        <h5 class="text-white mb-0">
          <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Erros Recentes na Criação
        </h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark table-hover" id="errorsTable">
            <thead>
              <tr>
                <th width="50" class="text-center">
                  <i class="fas fa-cog"></i>
                </th>
                <th class="text-center">
                  <i class="fas fa-hashtag me-1"></i>
                  ID Pedido
                </th>
                <th class="text-center">
                  <i class="fas fa-clock me-1"></i>
                  Data do Erro
                </th>
                <th class="text-center">
                  <i class="fas fa-exclamation-triangle me-1"></i>
                  Mensagem de Erro
                </th>
              </tr>
            </thead>
            <tbody>
              <% @failed_attempts.each do |attempt| %>
                <tr>
                  <td class="text-center">
                    <%= link_to verify_attempts_attempts_path(tiny_order_id: attempt.tiny_order_id), 
                        class: 'btn btn-sm btn-outline-info', 
                        method: :post, 
                        target: '_blank',
                        title: 'Verificar tentativas' do %>
                      <i class="fas fa-paperclip"></i>
                    <% end %>
                  </td>
                  <td class="text-center">
                    <span class="fw-bold text-white"><%= attempt.tiny_order_id %></span>
                  </td>
                  <td class="text-center">
                    <div class="d-flex flex-column align-items-center">
                      <span class="text-white"><%= attempt.updated_at.strftime('%d/%m/%Y') %></span>
                      <small class="text-muted"><%= attempt.updated_at.strftime('%H:%M') %></small>
                    </div>
                  </td>
                  <td class="text-center">
                    <span class="text-danger" title="<%= attempt.message %>">
                      <%= truncate(attempt.message, length: 50) %>
                    </span>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  <% end %>
</div>

<% content_for :styles do %>
  <style>
    body {
      background-color: #121212;
      color: #f8f9fa;
    }

    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2) !important;
    }

    .bg-black {
      background-color: #121212 !important;
    }

    .table-responsive {
      border-radius: 0.5rem;
      overflow: hidden;
    }

    .table th {
      background-color: #1a1a1a;
      border-color: #343a40;
      font-weight: 600;
      font-size: 0.875rem;
    }

    .table td {
      border-color: #343a40;
      vertical-align: middle;
    }

    .table tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .btn-sm {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }

    .badge {
      font-size: 0.75rem;
    }

    .fs-6 {
      font-size: 0.875rem !important;
    }

    .form-select, .form-control {
      color-scheme: dark;
    }

    .form-select option {
      background-color: #212529;
      color: #f8f9fa;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .fa-spin {
      animation: spin 1s linear infinite;
    }

    .alert-info {
      background-color: rgba(13, 202, 240, 0.1);
      border: 1px solid rgba(13, 202, 240, 0.3);
      color: #0dcaf0;
    }
  </style>
<% end %>

<% content_for :scripts do %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Inicializar DataTables
      function initializeDataTable(tableId, options = {}) {
        const table = document.getElementById(tableId);
        if (table && !$.fn.DataTable.isDataTable('#' + tableId)) {
          $('#' + tableId).DataTable({
            responsive: true,
            pageLength: 25,
            language: {
              url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json'
            },
            columnDefs: [
              { className: "text-center", targets: "_all" }
            ],
            ...options
          });
        }
      }

      if (document.getElementById('ordersTable')) {
        initializeDataTable('ordersTable', {
          order: [[3, 'desc']],
          columnDefs: [
            { orderable: false, targets: [0] },
            { className: "text-center", targets: "_all" }
          ]
        });
      }

      if (document.getElementById('errorsTable')) {
        initializeDataTable('errorsTable', {
          pageLength: 10,
          order: [[2, 'desc']],
          columnDefs: [
            { orderable: false, targets: [0] },
            { className: "text-center", targets: "_all" }
          ]
        });
      }

      // Tooltips
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
      var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });

      // Animação dos cards
      const cards = document.querySelectorAll('.card');
      cards.forEach((card, index) => {
        setTimeout(() => {
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        }, index * 50);
      });

      // Auto-refresh
      setInterval(function() {
        if (document.visibilityState === 'visible') {
          location.reload();
        }
      }, 60000);
    });
  </script>
<% end %>
